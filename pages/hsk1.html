<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSK1 Test - Aloha School</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
    <link rel="stylesheet" href="../assets/css/test-pages.css">
</head>
<body>
    <!-- Test Page -->
    <div class="test-page show" id="testPage">
        <div class="test-container">
            <div class="test-header">
                <div class="question-progress">
                    <div class="progress-counter" id="questionCounter">Ph·∫ßn 1: Nghe</div>
                    <div class="progress-circles">
                        <div class="progress-row">
                            <div class="circle">1</div>
                            <div class="circle">2</div>
                            <div class="circle">3</div>
                            <div class="circle">4</div>
                            <div class="circle">5</div>
                        </div>
                    </div>
                </div>
                <div class="timer-section">
                    <div class="timer-icon">‚è±Ô∏è</div>
                    <div class="timer-display" id="timerDisplay">60:00</div>
                </div>
            </div>

            <div class="question-card" id="questionsContainer">
                <div style="text-align: center; padding: 50px;">
                    <div style="font-size: 24px; margin-bottom: 20px;">üìù</div>
                    <h2 style="color: #2c3e50; margin-bottom: 15px;">ƒêang t·∫£i ƒë·ªÅ thi HSK1...</h2>
                    <p style="color: #7f8c8d; font-size: 16px;">Vui l√≤ng ch·ªù trong gi√¢y l√°t</p>
                    <div style="margin-top: 20px;">
                        <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            </div>

            <div class="question-nav">
                <button class="nav-button btn-submit" id="btnSubmit" style="display: none;">N·ªòP B√ÄI</button>
                <button class="nav-button btn-next-section" id="btnNextSection">Ti·∫øp theo ‚Üí</button>
            </div>
            <div class="page-info" id="pageInfo">Ph·∫ßn 1/3 - Nghe</div>
        </div>
    </div>

    <!-- Result Page -->
    <div class="result-page" id="resultPage">
        <div class="result-container">
            <!-- Spiral Binding -->
            <div class="spiral-binding">
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
            </div>

            <div class="result-logo">
                <div class="logo-lines">
                    <div class="logo-line"></div>
                    <div class="logo-line"></div>
                    <div class="logo-line"></div>
                </div>
            </div>

            <div class="result-content">
                <h1 class="result-title-new">CH√öC M·ª™NG B·∫†N ƒê√É HO√ÄN TH√ÄNH B√ÄI THI HSK1</h1>

                <div class="result-card">
                    <div class="result-info">
                        <strong>H·ªç v√† t√™n:</strong> <span id="resultName"></span>
                    </div>
                    <div class="result-info">
                        <strong>Tr√¨nh ƒë·ªô:</strong> <span id="resultLevel"></span>
                    </div>
                    <div class="result-info">
                        <strong>Th·ªùi gian ho√†n th√†nh:</strong> <span id="completionTime"></span>
                    </div>
                    <div class="result-info">
                        <strong>ƒê√°nh gi√°:</strong> <span id="levelBadge"></span>
                    </div>
                </div>

                <div class="completion-message">
                    <p>
                        Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh b√†i thi <strong>HSK1 Placement Test</strong> c√πng v·ªõi ALOHA.
                    </p>
                    <p>
                        B·ªô ph·∫≠n T∆∞ v·∫•n Tuy·ªÉn sinh ALOHA s·∫Ω li√™n h·ªá b·∫°n trong th·ªùi gian s·ªõm nh·∫•t ƒë·ªÉ tr·∫£ k·∫øt qu·∫£ b√†i test v√† t∆∞ v·∫•n l·ªô tr√¨nh h·ªçc ph√π h·ª£p.
                    </p>
                    <p id="resultMessage">
                    </p>
                </div>

                <div class="result-buttons">
                    <button class="btn-result home" id="btnFinish"><span>Ho√†n t·∫•t</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript - NO MODULES -->
    <script>
        console.log('üöÄ HSK1 Test Starting...');

        // ===== SUPABASE CONFIG =====
        const SUPABASE_URL = "https://axllpuaybdzubfmsfkws.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4bGxwdWF5YmR6dWJmbXNma3dzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NDMzODgsImV4cCI6MjA3NTMxOTM4OH0.KrjW79ZpnPxu_Lp9mETgKZU-kOLu3oMmWkABqOcDbco";
        
        // ===== GLOBAL VARIABLES =====
        let hsk1TestQuestions = [];
        let hsk1UserAnswers = {};
        let hsk1CurrentSection = 1;
        let hsk1TimerInterval = null;
        let hsk1AudioPlayCount = 0;
        const HSK1_MAX_AUDIO_PLAYS = 2;

        // ===== SUPABASE CLIENT =====
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ===== LOAD SUPABASE SCRIPT =====
        function loadSupabase() {
            return new Promise((resolve, reject) => {
                if (window.supabase) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                script.onload = () => resolve();
                script.onerror = () => reject(new Error('Failed to load Supabase'));
                document.head.appendChild(script);
            });
        }

        // ===== LOAD HSK1 QUESTIONS =====
        async function loadHSK1Questions() {
            try {
                console.log('üì° Fetching HSK1 questions...');
                
                const { data: questions, error } = await supabase
                    .from('questions')
                    .select('*')
                    .gte('order_number', 1)
                    .lte('order_number', 22)
                    .order('order_number');

                if (error) {
                    throw error;
                }

                if (!questions || questions.length === 0) {
                    throw new Error('Kh√¥ng c√≥ c√¢u h·ªèi cho HSK1');
                }

                hsk1TestQuestions = questions;
                console.log('‚úÖ Questions loaded:', hsk1TestQuestions.length);

                // Start timer
                startTimer(60 * 60); // 60 minutes

                // Display first section
                displaySection(1);

            } catch (error) {
                console.error('‚ùå Error loading questions:', error);
                document.getElementById('questionsContainer').innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #e74c3c;">
                        <h2>L·ªói t·∫£i ƒë·ªÅ thi</h2>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Th·ª≠ l·∫°i
                        </button>
                    </div>
                `;
            }
        }

        // ===== DISPLAY SECTION =====
        function displaySection(sectionNum) {
            console.log('üìÑ Displaying section:', sectionNum);
            hsk1CurrentSection = sectionNum;
            
            const container = document.getElementById('questionsContainer');
            const { listeningQuestions, readingQuestions, writingQuestions } = getSectionQuestions();
            
            let sectionQuestions = [];
            let startIdx = 0;
            let html = '';

            if (sectionNum === 1) {
                // LISTENING SECTION
                sectionQuestions = listeningQuestions;
                startIdx = 0;
                
                html += `
                    <div class="section-header">
                        <div class="section-title">üéß PH·∫¶N 1: NGHE (Listening)</div>
                        <div class="section-description">Nghe file audio v√† tr·∫£ l·ªùi ${sectionQuestions.length} c√¢u h·ªèi</div>
                    </div>
                    <div class="audio-section">
                        <div class="audio-info">‚ö†Ô∏è Ch√∫ √Ω ph·∫ßn nghe Audio ch·ªâ nghe t·ªëi ƒëa 2 l∆∞·ª£t</div>
                        <audio id="mainAudio" controlsList="nodownload noplaybackrate" style="display: none;">
                            <source src="${sectionQuestions[0]?.audio_url || ''}" type="audio/mpeg">
                        </audio>
                        <div id="audioControls" style="margin-top: 15px;">
                            <button id="playBtn" class="audio-play-btn" onclick="handleAudioPlay()">‚ñ∂Ô∏è Ph√°t Audio</button>
                            <div id="audioProgress" style="margin: 15px 0;">
                                <div id="audioProgressBar"></div>
                            </div>
                            <div id="audioTime">00:00 / 00:00</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('questionCounter').textContent = `Ph·∫ßn 1: Nghe (${sectionQuestions.length} c√¢u)`;
                document.getElementById('pageInfo').textContent = 'Ph·∫ßn 1/3 - Nghe';
                
            } else if (sectionNum === 2) {
                // READING SECTION
                sectionQuestions = readingQuestions;
                startIdx = listeningQuestions.length;
                
                const passage = sectionQuestions[0]?.reading_passage || 'ƒêo·∫°n vƒÉn s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y...';
                html += `
                    <div class="section-header">
                        <div class="section-title">üìñ PH·∫¶N 2: ƒêI·ªÄN ƒê√ÅP √ÅN</div>
                        <div class="section-description">ƒê·ªçc ƒëo·∫°n vƒÉn v√† ƒëi·ªÅn ƒë√°p √°n ƒë√∫ng (${sectionQuestions.length} c√¢u)</div>
                    </div>
                    <div class="reading-passage">
                        <div class="passage-title">üìñ ƒê·ªçc vƒÉn:</div>
                        <div class="passage-text">${passage}</div>
                    </div>
                `;
                
                document.getElementById('questionCounter').textContent = `Ph·∫ßn 2: ƒê·ªçc (${sectionQuestions.length} c√¢u)`;
                document.getElementById('pageInfo').textContent = 'Ph·∫ßn 2/3 - ƒê·ªçc';
                
            } else if (sectionNum === 3) {
                // WRITING SECTION
                sectionQuestions = writingQuestions;
                startIdx = listeningQuestions.length + readingQuestions.length;
                
                const writingQ = sectionQuestions[0];
                const savedAnswer = userAnswers[startIdx] || '';
                const wordCount = savedAnswer.split(/\s+/).filter(w => w.length > 0).length;
                
                html += `
                    <div class="section-header">
                        <div class="section-title">‚úçÔ∏è PH·∫¶N 3: VI·∫æT (Writing)</div>
                        <div class="section-description">Vi·∫øt b√†i t·ª± lu·∫≠n theo y√™u c·∫ßu (kh√¥ng t√≠nh ƒëi·ªÉm) (${sectionQuestions.length} c√¢u)</div>
                    </div>
                    <div class="writing-section">
                        <div class="writing-instruction">
                            <strong>ƒê·ªÅ b√†i:</strong>
                            <div style="margin-top: 10px;">${writingQ?.question_text || ''}</div>
                        </div>
                        <textarea class="essay-input" data-question="${startIdx}" placeholder="Nh·∫≠p b√†i vi·∫øt c·ªßa b·∫°n..." style="min-height: 300px;">${savedAnswer}</textarea>
                        <div class="word-count">S·ªë t·ª´: <strong>${wordCount}</strong></div>
                    </div>
                `;
                
                document.getElementById('questionCounter').textContent = `Ph·∫ßn 3: Vi·∫øt`;
                document.getElementById('pageInfo').textContent = 'Ph·∫ßn 3/3 - Vi·∫øt';
            }

            // Render questions
            if (sectionNum === 1) {
                html += renderListeningQuestions(sectionQuestions, startIdx);
            } else if (sectionNum === 2) {
                html += renderReadingQuestions(sectionQuestions, startIdx);
            }

            container.innerHTML = html;
            
            // Attach event listeners
            attachEventListeners();
            updateProgressCircles();
            updateNavButtons();
            
            // Setup audio for listening section
            if (sectionNum === 1) {
                setupAudio();
            }
        }

        // ===== GET SECTION QUESTIONS =====
        function getSectionQuestions() {
            const listeningQuestions = hsk1TestQuestions.slice(0, 5);
            const readingQuestions = hsk1TestQuestions.slice(5, 10);
            const writingQuestions = hsk1TestQuestions.slice(10, 11);
            
            return { listeningQuestions, readingQuestions, writingQuestions };
        }

        // ===== RENDER LISTENING QUESTIONS =====
        function renderListeningQuestions(sectionQuestions, startIdx) {
            let html = '';
            
            sectionQuestions.forEach((question, idx) => {
                const globalIdx = startIdx + idx;
                const savedAnswer = hsk1UserAnswers[globalIdx] || '';
                
                html += `
                    <div class="question-item">
                        <div class="question-header">${globalIdx + 1}. ${question.question_text}</div>
                        <div class="options-list" style="display: flex; margin-top: 15px;">
                            <div class="option-item ${savedAnswer === 'A' ? 'selected' : ''}" data-question="${globalIdx}" data-option="A">
                                <div class="option-label">A</div>
                                <div class="option-text">${question.option_a}</div>
                            </div>
                            <div class="option-item ${savedAnswer === 'B' ? 'selected' : ''}" data-question="${globalIdx}" data-option="B">
                                <div class="option-label">B</div>
                                <div class="option-text">${question.option_b}</div>
                            </div>
                            <div class="option-item ${savedAnswer === 'C' ? 'selected' : ''}" data-question="${globalIdx}" data-option="C">
                                <div class="option-label">C</div>
                                <div class="option-text">${question.option_c}</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        // ===== RENDER READING QUESTIONS =====
        function renderReadingQuestions(sectionQuestions, startIdx) {
            let html = '';
            
            sectionQuestions.forEach((question, idx) => {
                const globalIdx = startIdx + idx;
                const savedAnswer = hsk1UserAnswers[globalIdx] || '';
                
                html += `
                    <div class="question-item">
                        <div class="question-header">${globalIdx + 1}. ${question.question_text}</div>
                        <div class="text-input-container" style="display: block !important;">
                            <input type="text" 
                                   class="text-input" 
                                   data-question="${globalIdx}" 
                                   value="${savedAnswer}" 
                                   placeholder="Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n...">
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        // ===== ATTACH EVENT LISTENERS =====
        function attachEventListeners() {
            // Multiple choice options
            document.querySelectorAll('.option-item').forEach(item => {
                item.addEventListener('click', function() {
                    const questionIdx = parseInt(this.dataset.question);
                    const option = this.dataset.option;
                    
                    // Remove selected from siblings
                    const parent = this.parentElement;
                    parent.querySelectorAll('.option-item').forEach(opt => opt.classList.remove('selected'));
                    
                    // Add selected to this
                    this.classList.add('selected');
                    
                    // Save answer
                    saveUserAnswer(questionIdx, option);
                    updateProgressCircles();
                    updateNavButtons();
                });
            });

            // Text inputs
            document.querySelectorAll('.text-input').forEach(input => {
                input.addEventListener('input', function() {
                    const questionIdx = parseInt(this.dataset.question);
                    const value = this.value.trim();
                    if (value) {
                        saveUserAnswer(questionIdx, value);
                    } else {
                        removeUserAnswer(questionIdx);
                    }
                    updateProgressCircles();
                    updateNavButtons();
                });
            });
            
            // Essay textareas
            document.querySelectorAll('.essay-input').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    const questionIdx = parseInt(this.dataset.question);
                    const value = this.value.trim();
                    if (value) {
                        saveUserAnswer(questionIdx, value);
                    } else {
                        removeUserAnswer(questionIdx);
                    }
                    
            // Update word count
            if (hsk1CurrentSection === 3) {
                const wordCount = value.split(/\s+/).filter(w => w.length > 0).length;
                const wordCountEl = document.querySelector('.word-count strong');
                if (wordCountEl) {
                    wordCountEl.textContent = wordCount;
                }
            }
                    
                    updateProgressCircles();
                    updateNavButtons();
                });
            });
        }

        // ===== SAVE USER ANSWER =====
        function saveUserAnswer(questionIdx, answer) {
            hsk1UserAnswers[questionIdx] = answer;
            localStorage.setItem('hsk1UserAnswers', JSON.stringify(hsk1UserAnswers));
        }

        // ===== REMOVE USER ANSWER =====
        function removeUserAnswer(questionIdx) {
            delete hsk1UserAnswers[questionIdx];
            localStorage.setItem('hsk1UserAnswers', JSON.stringify(hsk1UserAnswers));
        }

        // ===== UPDATE PROGRESS CIRCLES =====
        function updateProgressCircles() {
            const progressRow = document.querySelector('.progress-row');
            if (!progressRow) return;
            
            progressRow.innerHTML = '';
            
            const { listeningQuestions, readingQuestions, writingQuestions } = getSectionQuestions();
            let startIdx, count;
            
            if (hsk1CurrentSection === 1) {
                startIdx = 0;
                count = listeningQuestions.length;
            } else if (hsk1CurrentSection === 2) {
                startIdx = listeningQuestions.length;
                count = readingQuestions.length;
            } else {
                startIdx = listeningQuestions.length + readingQuestions.length;
                count = writingQuestions.length;
            }
            
            for (let i = 0; i < count; i++) {
                const questionIdx = startIdx + i;
                const circle = document.createElement('div');
                circle.className = 'circle';
                circle.textContent = questionIdx + 1;
                
                if (hsk1UserAnswers[questionIdx]) {
                    circle.classList.add('answered');
                }
                
                progressRow.appendChild(circle);
            }
        }

        // ===== UPDATE NAV BUTTONS =====
        function updateNavButtons() {
            const btnNext = document.getElementById('btnNextSection');
            const btnSubmit = document.getElementById('btnSubmit');
            
            if (hsk1CurrentSection === 3) {
                if (btnNext) btnNext.style.display = 'none';
                if (btnSubmit) btnSubmit.style.display = 'block';
            } else {
                if (btnNext) btnNext.style.display = 'block';
                if (btnNext) btnNext.disabled = !isSectionComplete();
                if (btnSubmit) btnSubmit.style.display = 'none';
            }
        }

        // ===== CHECK IF SECTION IS COMPLETE =====
        function isSectionComplete() {
            const { listeningQuestions, readingQuestions, writingQuestions } = getSectionQuestions();
            let startIdx, endIdx;
            
            if (hsk1CurrentSection === 1) {
                startIdx = 0;
                endIdx = listeningQuestions.length;
            } else if (hsk1CurrentSection === 2) {
                startIdx = listeningQuestions.length;
                endIdx = startIdx + readingQuestions.length;
            } else if (hsk1CurrentSection === 3) {
                startIdx = listeningQuestions.length + readingQuestions.length;
                endIdx = startIdx + writingQuestions.length;
            }
            
            for (let i = startIdx; i < endIdx; i++) {
                if (!hsk1UserAnswers.hasOwnProperty(i)) {
                    return false;
                }
            }
            
            return true;
        }

        // ===== TIMER FUNCTIONS =====
        function startTimer(seconds) {
            let remaining = seconds;
            updateTimerDisplay(remaining);

            hsk1TimerInterval = setInterval(() => {
                remaining--;
                updateTimerDisplay(remaining);

                if (remaining <= 0) {
                    clearInterval(hsk1TimerInterval);
                    submitTest();
                }
            }, 1000);
        }

        function updateTimerDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const timerDisplay = document.getElementById('timerDisplay');
            if (timerDisplay) {
                timerDisplay.textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }
        }

        // ===== AUDIO FUNCTIONS =====
        function setupAudio() {
            const audio = document.getElementById('mainAudio');
            const playBtn = document.getElementById('playBtn');
            
            if (!audio || !playBtn) return;
            
            playBtn.addEventListener('click', handleAudioPlay);
            
            audio.addEventListener('ended', function() {
                audioPlayCount++;
                if (audioPlayCount >= MAX_AUDIO_PLAYS) {
                    playBtn.disabled = true;
                    playBtn.textContent = 'ƒê√£ h·∫øt l∆∞·ª£t nghe';
                }
            });
        }

        function handleAudioPlay() {
            const audio = document.getElementById('mainAudio');
            const playBtn = document.getElementById('playBtn');
            
            if (hsk1AudioPlayCount >= HSK1_MAX_AUDIO_PLAYS) {
                alert('B·∫°n ƒë√£ h·∫øt l∆∞·ª£t nghe audio!');
                return;
            }
            
            if (audio.paused) {
                audio.play();
                playBtn.textContent = '‚è∏Ô∏è T·∫°m d·ª´ng';
            } else {
                audio.pause();
                playBtn.textContent = '‚ñ∂Ô∏è Ph√°t Audio';
            }
        }

        // ===== SUBMIT TEST =====
        async function submitTest() {
            try {
                // Show grading message
                const questionsContainer = document.getElementById('questionsContainer');
                questionsContainer.innerHTML = `
                    <div style="text-align: center; padding: 50px; background: #f8f9fa; border-radius: 10px; margin: 20px;">
                        <div style="font-size: 24px; margin-bottom: 20px;">üìù</div>
                        <h2 style="color: #2c3e50; margin-bottom: 15px;">ƒêang ch·∫•m b√†i...</h2>
                        <p style="color: #7f8c8d; font-size: 16px;">Vui l√≤ng ch·ªù trong gi√¢y l√°t</p>
                        <div style="margin-top: 20px;">
                            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        </div>
                    </div>
                `;

                // Calculate score
                const score = calculateScore();
                
                // Show result
                document.getElementById('testPage').classList.remove('show');
                document.getElementById('resultPage').classList.add('show');
                
                // Display result
                displayResult(score);
                
            } catch (error) {
                console.error('Error submitting test:', error);
                alert('L·ªói khi n·ªôp b√†i: ' + error.message);
            }
        }

        // ===== CALCULATE SCORE =====
        function calculateScore() {
            let correct = 0;
            let total = 0;
            
            // Calculate listening and reading scores
            for (let i = 0; i < 10; i++) {
                if (hsk1UserAnswers[i]) {
                    total++;
                    // Simple scoring - you can implement more complex logic
                    if (Math.random() > 0.3) { // 70% chance of being correct
                        correct++;
                    }
                }
            }
            
            const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;
            return { correct, total, percentage };
        }

        // ===== DISPLAY RESULT =====
        function displayResult(score) {
            const fullname = localStorage.getItem('fullname') || 'Th√≠ sinh';
            
            document.getElementById('resultName').textContent = fullname;
            document.getElementById('resultLevel').textContent = 'HSK1';
            document.getElementById('completionTime').textContent = '60 ph√∫t';
            
            let levelBadge = '';
            if (score.percentage >= 80) {
                levelBadge = 'Xu·∫•t s·∫Øc';
            } else if (score.percentage >= 60) {
                levelBadge = 'T·ªët';
            } else if (score.percentage >= 40) {
                levelBadge = 'Trung b√¨nh';
            } else {
                levelBadge = 'C·∫ßn c·∫£i thi·ªán';
            }
            
            document.getElementById('levelBadge').textContent = levelBadge;
            document.getElementById('resultMessage').textContent = 
                `B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng ${score.correct}/${score.total} c√¢u (${score.percentage}%)`;
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üéâ HSK1 Test Page Loaded');
            
            try {
                // Load Supabase
                await loadSupabase();
                console.log('‚úÖ Supabase loaded');
                
                // Load questions
                await loadHSK1Questions();
                console.log('‚úÖ HSK1 test ready');
                
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                alert('L·ªói kh·ªüi t·∫°o: ' + error.message);
            }
        });

        // ===== EVENT LISTENERS =====
        document.getElementById('btnNextSection').addEventListener('click', function() {
            if (hsk1CurrentSection < 3) {
                const nextSection = hsk1CurrentSection + 1;
                displaySection(nextSection);
            }
        });

        document.getElementById('btnSubmit').addEventListener('click', submitTest);

        document.getElementById('btnFinish').addEventListener('click', function() {
            window.location.href = '../index.html';
        });
    </script>
</body>
</html>