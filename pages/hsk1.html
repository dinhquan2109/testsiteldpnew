<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSK1 Test - Aloha School</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/components.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
    <link rel="stylesheet" href="../assets/css/test-pages.css">
</head>
<body>
    <!-- Test Page -->
    <div class="test-page show" id="testPage">
        <div class="test-container">
            <div class="test-header">
                <div class="question-progress">
                    <div class="progress-counter" id="questionCounter">Ph·∫ßn 1: Nghe</div>
                    <div class="progress-circles">
                        <div class="progress-row">
                            <div class="circle">1</div>
                            <div class="circle">2</div>
                            <div class="circle">3</div>
                            <div class="circle">4</div>
                            <div class="circle">5</div>
                        </div>
                    </div>
                </div>
                <div class="timer-section">
                    <div class="timer-icon">‚è±Ô∏è</div>
                    <div class="timer-display" id="timerDisplay">60:00</div>
                </div>
            </div>

            <div class="question-card" id="questionsContainer">
                <div style="text-align: center; padding: 50px;">
                    <div style="font-size: 24px; margin-bottom: 20px;">üìù</div>
                    <h2 style="color: #2c3e50; margin-bottom: 15px;">ƒêang t·∫£i ƒë·ªÅ thi HSK1...</h2>
                    <p style="color: #7f8c8d; font-size: 16px;">Vui l√≤ng ch·ªù trong gi√¢y l√°t</p>
                    <div style="margin-top: 20px;">
                        <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            </div>

            <div class="question-nav">
                <button class="nav-button btn-submit" id="btnSubmit" style="display: none;">N·ªòP B√ÄI</button>
                <button class="nav-button btn-next-section" id="btnNextSection">Ti·∫øp theo ‚Üí</button>
            </div>
            <div class="page-info" id="pageInfo">Ph·∫ßn 1/3 - Nghe</div>
        </div>
    </div>

    <!-- Result Page -->
    <div class="result-page" id="resultPage">
        <div class="result-container">
            <!-- Spiral Binding -->
            <div class="spiral-binding">
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
                <div class="spiral-hole"></div>
            </div>

            <div class="result-logo">
                <div class="logo-lines">
                    <div class="logo-line"></div>
                    <div class="logo-line"></div>
                    <div class="logo-line"></div>
                </div>
            </div>

            <div class="result-content">
                <h1 class="result-title-new">CH√öC M·ª™NG B·∫†N ƒê√É HO√ÄN TH√ÄNH B√ÄI THI HSK1</h1>

                <div class="result-card">
                    <div class="result-info">
                        <strong>H·ªç v√† t√™n:</strong> <span id="resultName"></span>
                    </div>
                    <div class="result-info">
                        <strong>Tr√¨nh ƒë·ªô:</strong> <span id="resultLevel"></span>
                    </div>
                    <div class="result-info">
                        <strong>Th·ªùi gian ho√†n th√†nh:</strong> <span id="completionTime"></span>
                    </div>
                    <div class="result-info">
                        <strong>ƒê√°nh gi√°:</strong> <span id="levelBadge"></span>
                    </div>
                </div>

                <div class="completion-message">
                    <p>
                        Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh b√†i thi <strong>HSK1 Placement Test</strong> c√πng v·ªõi ALOHA.
                    </p>
                    <p>
                        B·ªô ph·∫≠n T∆∞ v·∫•n Tuy·ªÉn sinh ALOHA s·∫Ω li√™n h·ªá b·∫°n trong th·ªùi gian s·ªõm nh·∫•t ƒë·ªÉ tr·∫£ k·∫øt qu·∫£ b√†i test v√† t∆∞ v·∫•n l·ªô tr√¨nh h·ªçc ph√π h·ª£p.
                    </p>
                    <p id="resultMessage">
                    </p>
                </div>

                <div class="ai-feedback-section" style="display: none; margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <!-- AI feedback will be inserted here -->
                </div>

                <div class="result-buttons">
                    <button class="btn-result home" id="btnFinish"><span>Ho√†n t·∫•t</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript - NO MODULES -->
    <script>
        console.log('üöÄ HSK1 Test Starting...');

        // ===== SUPABASE CONFIG =====
        const SUPABASE_URL = "https://axllpuaybdzubfmsfkws.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4bGxwdWF5YmR6dWJmbXNma3dzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NDMzODgsImV4cCI6MjA3NTMxOTM4OH0.KrjW79ZpnPxu_Lp9mETgKZU-kOLu3oMmWkABqOcDbco";
        
        // ===== GLOBAL VARIABLES =====
        let hsk1TestQuestions = [];
        let hsk1UserAnswers = {};
        let hsk1CurrentSection = 1;
        let hsk1TimerInterval = null;
        let hsk1AudioPlayCount = 0;
        const HSK1_MAX_AUDIO_PLAYS = 2;

        // ===== SUPABASE CLIENT =====
        let supabase = null;

        // ===== LOAD SUPABASE SCRIPT =====
        function loadSupabase() {
            return new Promise((resolve, reject) => {
                if (window.supabase) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                script.onload = () => {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    resolve();
                };
                script.onerror = () => reject(new Error('Failed to load Supabase'));
                document.head.appendChild(script);
            });
        }

        // ===== LOAD HSK1 QUESTIONS =====
        async function loadHSK1Questions() {
            try {
                console.log('üì° Fetching HSK1 questions...');
                console.log('üîó Supabase client:', supabase);
                
                if (!supabase) {
                    throw new Error('Supabase client not initialized');
                }
                
                const { data: questions, error } = await supabase
                    .from('questions')
                    .select('*')
                    .gte('order_number', 1)
                    .lte('order_number', 11)
                    .order('order_number');

                if (error) {
                    throw error;
                }

                if (!questions || questions.length === 0) {
                    console.log('‚ö†Ô∏è No questions from Supabase, using fallback data');
                    hsk1TestQuestions = generateFallbackQuestions();
                } else {
                    hsk1TestQuestions = questions;
                }
                
                console.log('‚úÖ Questions loaded:', hsk1TestQuestions.length);

                // Start timer
                startTimer(60); // 60 minutes

                // Display first section
                displaySection(1);

            } catch (error) {
                console.error('‚ùå Error loading questions:', error);
                document.getElementById('questionsContainer').innerHTML = `
                    <div style="text-align: center; padding: 50px; color: #e74c3c;">
                        <h2>L·ªói t·∫£i ƒë·ªÅ thi</h2>
                        <p>${error.message}</p>
                        <button onclick="location.reload()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Th·ª≠ l·∫°i
                        </button>
                    </div>
                `;
            }
        }

        // ===== GENERATE FALLBACK QUESTIONS =====
        function generateFallbackQuestions() {
            return [
                // Listening questions (1-5)
                {
                    id: 1,
                    order_number: 1,
                    question_text: "Nghe v√† ch·ªçn ƒë√°p √°n ƒë√∫ng",
                    option_a: "A. ‰Ω†Â•Ω",
                    option_b: "B. ÂÜçËßÅ", 
                    option_c: "C. Ë∞¢Ë∞¢",
                    correct_answer: "A",
                    audio_url: "https://example.com/audio1.mp3"
                },
                {
                    id: 2,
                    order_number: 2,
                    question_text: "Nghe v√† ch·ªçn ƒë√°p √°n ƒë√∫ng",
                    option_a: "A. ËãπÊûú",
                    option_b: "B. È¶ôËïâ",
                    option_c: "C. Ê©ôÂ≠ê",
                    correct_answer: "A",
                    audio_url: "https://example.com/audio2.mp3"
                },
                {
                    id: 3,
                    order_number: 3,
                    question_text: "Nghe v√† ch·ªçn ƒë√°p √°n ƒë√∫ng",
                    option_a: "A. Á∫¢Ëâ≤",
                    option_b: "B. ËìùËâ≤",
                    option_c: "C. ÁªøËâ≤",
                    correct_answer: "A",
                    audio_url: "https://example.com/audio3.mp3"
                },
                {
                    id: 4,
                    order_number: 4,
                    question_text: "Nghe v√† ch·ªçn ƒë√°p √°n ƒë√∫ng",
                    option_a: "A. ‰∏Ä",
                    option_b: "B. ‰∫å",
                    option_c: "C. ‰∏â",
                    correct_answer: "A",
                    audio_url: "https://example.com/audio4.mp3"
                },
                {
                    id: 5,
                    order_number: 5,
                    question_text: "Nghe v√† ch·ªçn ƒë√°p √°n ƒë√∫ng",
                    option_a: "A. Â§ß",
                    option_b: "B. Â∞è",
                    option_c: "C. È´ò",
                    correct_answer: "A",
                    audio_url: "https://example.com/audio5.mp3"
                },
                // Reading questions (6-10)
                {
                    id: 6,
                    order_number: 6,
                    question_text: "Ch·ªçn t·ª´ ƒë√∫ng",
                    option_a: "A. ‰π¶",
                    option_b: "B. Á¨î",
                    option_c: "C. Á∫∏",
                    correct_answer: "A",
                    reading_passage: "ËøôÊòØ‰∏ÄÊú¨‰π¶„ÄÇ"
                },
                {
                    id: 7,
                    order_number: 7,
                    question_text: "Ch·ªçn t·ª´ ƒë√∫ng",
                    option_a: "A. Áå´",
                    option_b: "B. Áãó",
                    option_c: "C. È∏ü",
                    correct_answer: "A",
                    reading_passage: "ËøôÊòØ‰∏ÄÂè™Áå´„ÄÇ"
                },
                {
                    id: 8,
                    order_number: 8,
                    question_text: "Ch·ªçn t·ª´ ƒë√∫ng",
                    option_a: "A. Ê∞¥",
                    option_b: "B. ÁÅ´",
                    option_c: "C. Âúü",
                    correct_answer: "A",
                    reading_passage: "ËøôÊòØÊ∞¥„ÄÇ"
                },
                {
                    id: 9,
                    order_number: 9,
                    question_text: "Ch·ªçn t·ª´ ƒë√∫ng",
                    option_a: "A. Â§©",
                    option_b: "B. Âú∞",
                    option_c: "C. ‰∫∫",
                    correct_answer: "A",
                    reading_passage: "ËøôÊòØÂ§©„ÄÇ"
                },
                {
                    id: 10,
                    order_number: 10,
                    question_text: "Ch·ªçn t·ª´ ƒë√∫ng",
                    option_a: "A. Â±±",
                    option_b: "B. Êµ∑",
                    option_c: "C. Ê≤≥",
                    correct_answer: "A",
                    reading_passage: "ËøôÊòØÂ±±„ÄÇ"
                },
                // Writing question (11)
                {
                    id: 11,
                    order_number: 11,
                    question_text: "Vi·∫øt m·ªôt ƒëo·∫°n vƒÉn ng·∫Øn v·ªÅ gia ƒë√¨nh b·∫°n (kh√¥ng t√≠nh ƒëi·ªÉm)",
                    correct_answer: "",
                    writing_prompt: "ËØ∑ÂÜô‰∏ÄÊÆµÂÖ≥‰∫é‰Ω†ÂÆ∂Â∫≠ÁöÑÁü≠Êñá„ÄÇ"
                }
            ];
        }

        // ===== DISPLAY SECTION =====
        function displaySection(sectionNum) {
            console.log('üìÑ Displaying section:', sectionNum);
            hsk1CurrentSection = sectionNum;
            
            const container = document.getElementById('questionsContainer');
            const { listeningQuestions, readingQuestions, writingQuestions } = getSectionQuestions();
            
            let sectionQuestions = [];
            let startIdx = 0;
            let html = '';

            if (sectionNum === 1) {
                // LISTENING SECTION
                sectionQuestions = listeningQuestions;
                startIdx = 0;
                
                html += `
                    <div class="section-header">
                        <div class="section-title">üéß PH·∫¶N 1: NGHE (Listening)</div>
                        <div class="section-description">Nghe file audio v√† tr·∫£ l·ªùi ${sectionQuestions.length} c√¢u h·ªèi</div>
                    </div>
                    <div class="audio-section">
                        <div class="audio-info">‚ö†Ô∏è Ch√∫ √Ω ph·∫ßn nghe Audio ch·ªâ nghe t·ªëi ƒëa 2 l∆∞·ª£t</div>
                        <audio id="mainAudio" controlsList="nodownload noplaybackrate" style="display: none;">
                            <source src="${sectionQuestions[0]?.audio_url || ''}" type="audio/mpeg">
                        </audio>
                        <div id="audioControls" style="margin-top: 15px;">
                            <button id="playBtn" class="audio-play-btn" onclick="handleAudioPlay()">‚ñ∂Ô∏è Ph√°t Audio</button>
                            <div id="audioProgress" style="margin: 15px 0;">
                                <div id="audioProgressBar"></div>
                            </div>
                            <div id="audioTime">00:00 / 00:00</div>
                        </div>
                    </div>
                `;
                
                document.getElementById('questionCounter').textContent = `Ph·∫ßn 1: Nghe (${sectionQuestions.length} c√¢u)`;
                document.getElementById('pageInfo').textContent = 'Ph·∫ßn 1/3 - Nghe';
                
            } else if (sectionNum === 2) {
                // READING SECTION
                sectionQuestions = readingQuestions;
                startIdx = listeningQuestions.length;
                
                const passage = sectionQuestions[0]?.reading_passage || 'ƒêo·∫°n vƒÉn s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y...';
                html += `
                    <div class="section-header">
                        <div class="section-title">üìñ PH·∫¶N 2: ƒêI·ªÄN ƒê√ÅP √ÅN</div>
                        <div class="section-description">ƒê·ªçc ƒëo·∫°n vƒÉn v√† ƒëi·ªÅn ƒë√°p √°n ƒë√∫ng (${sectionQuestions.length} c√¢u)</div>
                    </div>
                    <div class="reading-passage">
                        <div class="passage-title">üìñ ƒê·ªçc vƒÉn:</div>
                        <div class="passage-text">${passage}</div>
                    </div>
                `;
                
                document.getElementById('questionCounter').textContent = `Ph·∫ßn 2: ƒê·ªçc (${sectionQuestions.length} c√¢u)`;
                document.getElementById('pageInfo').textContent = 'Ph·∫ßn 2/3 - ƒê·ªçc';
                
            } else if (sectionNum === 3) {
                // WRITING SECTION
                sectionQuestions = writingQuestions;
                startIdx = listeningQuestions.length + readingQuestions.length;
                
                const writingQ = sectionQuestions[0];
                const savedAnswer = hsk1UserAnswers[startIdx] || '';
                const wordCount = savedAnswer.split(/\s+/).filter(w => w.length > 0).length;
                
                html += `
                    <div class="section-header">
                        <div class="section-title">‚úçÔ∏è PH·∫¶N 3: VI·∫æT (Writing)</div>
                        <div class="section-description">Vi·∫øt b√†i t·ª± lu·∫≠n theo y√™u c·∫ßu (kh√¥ng t√≠nh ƒëi·ªÉm) (${sectionQuestions.length} c√¢u)</div>
                    </div>
                    <div class="writing-section">
                        <div class="writing-instruction">
                            <strong>ƒê·ªÅ b√†i:</strong>
                            <div style="margin-top: 10px;">${writingQ?.question_text || ''}</div>
                        </div>
                        <textarea class="essay-input" data-question="${startIdx}" placeholder="Nh·∫≠p b√†i vi·∫øt c·ªßa b·∫°n..." style="min-height: 300px;">${savedAnswer}</textarea>
                        <div class="word-count">S·ªë t·ª´: <strong>${wordCount}</strong></div>
                    </div>
                `;
                
                document.getElementById('questionCounter').textContent = `Ph·∫ßn 3: Vi·∫øt`;
                document.getElementById('pageInfo').textContent = 'Ph·∫ßn 3/3 - Vi·∫øt';
            }

            // Render questions
            if (sectionNum === 1) {
                html += renderListeningQuestions(sectionQuestions, startIdx);
            } else if (sectionNum === 2) {
                html += renderReadingQuestions(sectionQuestions, startIdx);
            }

            container.innerHTML = html;
            
            // Attach event listeners
            attachEventListeners();
            updateProgressCircles();
            updateNavButtons();
            
            // Setup audio for listening section
            if (sectionNum === 1) {
                setupAudio();
            }
        }

        // ===== GET SECTION QUESTIONS =====
        function getSectionQuestions() {
            const listeningQuestions = hsk1TestQuestions.slice(0, 5);
            const readingQuestions = hsk1TestQuestions.slice(5, 10);
            const writingQuestions = hsk1TestQuestions.slice(10, 11);
            
            return { listeningQuestions, readingQuestions, writingQuestions };
        }

        // ===== RENDER LISTENING QUESTIONS =====
        function renderListeningQuestions(sectionQuestions, startIdx) {
            let html = '';
            
            sectionQuestions.forEach((question, idx) => {
                const globalIdx = startIdx + idx;
                const savedAnswer = hsk1UserAnswers[globalIdx] || '';
                
                html += `
                    <div class="question-item">
                        <div class="question-header">${globalIdx + 1}. ${question.question_text}</div>
                        <div class="options-list" style="display: flex; margin-top: 15px;">
                            <div class="option-item ${savedAnswer === 'A' ? 'selected' : ''}" data-question="${globalIdx}" data-option="A">
                                <div class="option-label">A</div>
                                <div class="option-text">${question.option_a}</div>
                            </div>
                            <div class="option-item ${savedAnswer === 'B' ? 'selected' : ''}" data-question="${globalIdx}" data-option="B">
                                <div class="option-label">B</div>
                                <div class="option-text">${question.option_b}</div>
                            </div>
                            <div class="option-item ${savedAnswer === 'C' ? 'selected' : ''}" data-question="${globalIdx}" data-option="C">
                                <div class="option-label">C</div>
                                <div class="option-text">${question.option_c}</div>
                </div>
            </div>
                    </div>
                `;
            });
            
            return html;
        }

        // ===== RENDER READING QUESTIONS =====
        function renderReadingQuestions(sectionQuestions, startIdx) {
            let html = '';
            
            sectionQuestions.forEach((question, idx) => {
                const globalIdx = startIdx + idx;
                const savedAnswer = hsk1UserAnswers[globalIdx] || '';
                
                html += `
                    <div class="question-item">
                        <div class="question-header">${globalIdx + 1}. ${question.question_text}</div>
                        <div class="text-input-container" style="display: block !important;">
                            <input type="text" 
                                   class="text-input" 
                                   data-question="${globalIdx}" 
                                   value="${savedAnswer}" 
                                   placeholder="Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n...">
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        // ===== ATTACH EVENT LISTENERS =====
        function attachEventListeners() {
            // Multiple choice options
            document.querySelectorAll('.option-item').forEach(item => {
                item.addEventListener('click', function() {
                    const questionIdx = parseInt(this.dataset.question);
                    const option = this.dataset.option;
                    
                    // Remove selected from siblings
                    const parent = this.parentElement;
                    parent.querySelectorAll('.option-item').forEach(opt => opt.classList.remove('selected'));
                    
                    // Add selected to this
                    this.classList.add('selected');
                    
                    // Save answer
                    saveUserAnswer(questionIdx, option);
                    updateProgressCircles();
                    updateNavButtons();
                });
            });

            // Text inputs
            document.querySelectorAll('.text-input').forEach(input => {
                input.addEventListener('input', function() {
                    const questionIdx = parseInt(this.dataset.question);
                    const value = this.value.trim();
                    if (value) {
                        saveUserAnswer(questionIdx, value);
                    } else {
                        removeUserAnswer(questionIdx);
                    }
                    updateProgressCircles();
                    updateNavButtons();
                });
            });
            
            // Essay textareas
            document.querySelectorAll('.essay-input').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    const questionIdx = parseInt(this.dataset.question);
                    const value = this.value.trim();
                    if (value) {
                        saveUserAnswer(questionIdx, value);
                    } else {
                        removeUserAnswer(questionIdx);
                    }
                    
            // Update word count
            if (hsk1CurrentSection === 3) {
                const wordCount = value.split(/\s+/).filter(w => w.length > 0).length;
                const wordCountEl = document.querySelector('.word-count strong');
                if (wordCountEl) {
                    wordCountEl.textContent = wordCount;
                }
            }
                    
                    updateProgressCircles();
                    updateNavButtons();
                });
            });
        }

        // ===== SAVE USER ANSWER =====
        function saveUserAnswer(questionIdx, answer) {
            hsk1UserAnswers[questionIdx] = answer;
            localStorage.setItem('hsk1UserAnswers', JSON.stringify(hsk1UserAnswers));
        }

        // ===== REMOVE USER ANSWER =====
        function removeUserAnswer(questionIdx) {
            delete hsk1UserAnswers[questionIdx];
            localStorage.setItem('hsk1UserAnswers', JSON.stringify(hsk1UserAnswers));
        }

        // ===== UPDATE PROGRESS CIRCLES =====
        function updateProgressCircles() {
            const progressRow = document.querySelector('.progress-row');
            if (!progressRow) return;
            
            progressRow.innerHTML = '';
            
            const { listeningQuestions, readingQuestions, writingQuestions } = getSectionQuestions();
            let startIdx, count;
            
            if (hsk1CurrentSection === 1) {
                startIdx = 0;
                count = listeningQuestions.length;
            } else if (hsk1CurrentSection === 2) {
                startIdx = listeningQuestions.length;
                count = readingQuestions.length;
            } else {
                startIdx = listeningQuestions.length + readingQuestions.length;
                count = writingQuestions.length;
            }
            
            for (let i = 0; i < count; i++) {
                const questionIdx = startIdx + i;
                const circle = document.createElement('div');
                circle.className = 'circle';
                circle.textContent = questionIdx + 1;
                
                if (hsk1UserAnswers[questionIdx]) {
                    circle.classList.add('answered');
                }
                
                progressRow.appendChild(circle);
            }
        }

        // ===== UPDATE NAV BUTTONS =====
        function updateNavButtons() {
            const btnNext = document.getElementById('btnNextSection');
            const btnSubmit = document.getElementById('btnSubmit');
            
            if (hsk1CurrentSection === 3) {
                if (btnNext) btnNext.style.display = 'none';
                if (btnSubmit) btnSubmit.style.display = 'block';
            } else {
                if (btnNext) btnNext.style.display = 'block';
                if (btnNext) btnNext.disabled = !isSectionComplete();
                if (btnSubmit) btnSubmit.style.display = 'none';
            }
        }

        // ===== CHECK IF SECTION IS COMPLETE =====
        function isSectionComplete() {
            const { listeningQuestions, readingQuestions, writingQuestions } = getSectionQuestions();
            let startIdx, endIdx;
            
            if (hsk1CurrentSection === 1) {
                startIdx = 0;
                endIdx = listeningQuestions.length;
            } else if (hsk1CurrentSection === 2) {
                startIdx = listeningQuestions.length;
                endIdx = startIdx + readingQuestions.length;
            } else if (hsk1CurrentSection === 3) {
                startIdx = listeningQuestions.length + readingQuestions.length;
                endIdx = startIdx + writingQuestions.length;
            }
            
            for (let i = startIdx; i < endIdx; i++) {
                if (!hsk1UserAnswers.hasOwnProperty(i)) {
                    return false;
                }
            }
            
            return true;
        }

        // ===== TIMER FUNCTIONS =====
        function startTimer(minutes) {
            let remaining = minutes * 60; // Convert minutes to seconds
            updateTimerDisplay(remaining);

            hsk1TimerInterval = setInterval(() => {
                remaining--;
                updateTimerDisplay(remaining);

                if (remaining <= 0) {
                    clearInterval(hsk1TimerInterval);
                    submitTest();
                }
            }, 1000);
        }

        function updateTimerDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            const timerDisplay = document.getElementById('timerDisplay');
            if (timerDisplay) {
                timerDisplay.textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            }
        }

        // ===== AUDIO FUNCTIONS =====
        function setupAudio() {
            const audio = document.getElementById('mainAudio');
            const playBtn = document.getElementById('playBtn');
            
            if (!audio || !playBtn) return;
            
            playBtn.addEventListener('click', handleAudioPlay);
            
            audio.addEventListener('ended', function() {
                hsk1AudioPlayCount++;
                if (hsk1AudioPlayCount >= HSK1_MAX_AUDIO_PLAYS) {
                    playBtn.disabled = true;
                    playBtn.textContent = 'ƒê√£ h·∫øt l∆∞·ª£t nghe';
                }
            });
        }

        function handleAudioPlay() {
            const audio = document.getElementById('mainAudio');
            const playBtn = document.getElementById('playBtn');
            
            if (hsk1AudioPlayCount >= HSK1_MAX_AUDIO_PLAYS) {
                alert('B·∫°n ƒë√£ h·∫øt l∆∞·ª£t nghe audio!');
                return;
            }
            
            if (audio.paused) {
                audio.play();
                playBtn.textContent = '‚è∏Ô∏è T·∫°m d·ª´ng';
            } else {
                audio.pause();
                playBtn.textContent = '‚ñ∂Ô∏è Ph√°t Audio';
            }
        }

        // ===== AI WRITING SCORE =====
        async function getAIWritingScore(essay, hskLevel) {
            try {
                const rubric = `B·∫°n l√† gi√°o vi√™n ti·∫øng Trung. H√£y ch·∫•m ƒëi·ªÉm b√†i vi·∫øt theo 5 ti√™u ch√≠, m·ªói ti√™u ch√≠ 0-2 ƒëi·ªÉm (t·ªïng 10).
1) N·ªôi dung (ÂÜÖÂÆπ): c√≥ ƒë·ªß th√¥ng tin: t√™n, tu·ªïi, ngh·ªÅ/h·ªçc v·∫•n, s·ªü th√≠ch, nh·∫≠n x√©t; ƒë·ªß 20-30 t·ª´.
2) T·ª´ v·ª±ng (ËØçÊ±á): d√πng ƒë√∫ng v√† ph√π h·ª£p c·∫•p ƒë·ªô HSK${hskLevel || '1'}.
3) Ng·ªØ ph√°p (ËØ≠Ê≥ï): c·∫•u tr√∫c ƒë√∫ng, c√¢u ho√†n ch·ªânh.
4) T√≠nh li√™n k·∫øt (ËøûË¥ØÊÄß): m·∫°ch l·∫°c, t·ª± nhi√™n.
5) Bi·ªÉu ƒë·∫°t & c·∫£m x√∫c (Ë°®Ëææ): c√≥ c·∫£m x√∫c, t·ª± nhi√™n, t√≠ch c·ª±c.
Tr·∫£ v·ªÅ JSON thu·∫ßn theo schema: {"content":0-2,"vocab":0-2,"grammar":0-2,"coherence":0-2,"expression":0-2,"total":0-10,"notes":"ng·∫Øn g·ªçn"}. Kh√¥ng k√®m vƒÉn b·∫£n n√†o ngo√†i JSON.`;

                const GEMINI_API_KEY = 'AIzaSyA0KtdYeuXgVA33SgZHpfYZLrsJN1uouSQ';
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
                
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `${rubric}\n\nB√†i vi·∫øt:\n${essay}` }]}]
                    })
                });
                
                if (!response.ok) throw new Error('AI scoring API error');
                
                const data = await response.json();
                const raw = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                
                try {
                    const jsonStart = raw.indexOf('{');
                    const jsonEnd = raw.lastIndexOf('}');
                    const jsonText = raw.substring(jsonStart, jsonEnd + 1);
                    return JSON.parse(jsonText);
                } catch {
                    return null;
                }
            } catch (error) {
                console.error('Error getting AI writing score:', error);
                return null;
            }
        }

        // ===== AI WRITING COMMENT =====
        async function getAIWritingComment(essay, hskLevel) {
            try {
                const prompt = `B·∫°n l√† gi√°o vi√™n ti·∫øng Trung. H√£y vi·∫øt nh·∫≠n x√©t ng·∫Øn g·ªçn, th√¢n thi·ªán (120-200 ch·ªØ), ch·ªâ ra ƒëi·ªÉm m·∫°nh v√† ƒëi·ªÉm c·∫ßn c·∫£i thi·ªán theo 5 ti√™u ch√≠: n·ªôi dung, t·ª´ v·ª±ng (HSK${hskLevel||'1'}), ng·ªØ ph√°p, li√™n k·∫øt, bi·ªÉu ƒë·∫°t & c·∫£m x√∫c. K·∫øt th√∫c b·∫±ng l·ªùi ƒë·ªông vi√™n. Nh·∫≠n x√©t b·∫±ng ti·∫øng vi·ªát nh√©, ph·∫ßn ƒë·∫ßu s·∫Ω l√† Ch√†o em v√† n√≥i th√™m 1, 2 c√¢u g√¨ ƒë√≥ kh√≠ch l·ªá.`;
                
                const GEMINI_API_KEY = 'AIzaSyA0KtdYeuXgVA33SgZHpfYZLrsJN1uouSQ';
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
                
                const response = await fetch(apiUrl, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt + "\n\nB√†i vi·∫øt:\n" + essay }]}]
                    })
                });
                
                if (!response.ok) throw new Error('AI comment API error');
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            } catch (error) {
                console.error('Error getting AI writing comment:', error);
                return '';
            }
        }

        // ===== SAVE TEST RESULTS TO SUPABASE =====
        async function saveTestResults(resultData) {
            try {
                const { error } = await supabase
                    .from('test_results')
                    .insert([{
                        placement_id: resultData.userId,
                        answers: resultData.answers,
                        score: resultData.score,
                        writing_ai_score: resultData.writingAIScore || 0,
                        writing_ai_comment: resultData.writingAIComment || '',
                        selected_level: resultData.selectedHSK,
                        completed_at: new Date().toISOString()
                    }]);

                if (error) throw error;
                return { success: true };
            } catch (error) {
                console.error('Error saving test results:', error);
                return { success: false, error: error.message };
            }
        }

        // ===== SUBMIT TEST =====
        async function submitTest() {
            try {
                // Show grading message
                const questionsContainer = document.getElementById('questionsContainer');
                questionsContainer.innerHTML = `
                    <div style="text-align: center; padding: 50px; background: #f8f9fa; border-radius: 10px; margin: 20px;">
                        <div style="font-size: 24px; margin-bottom: 20px;">üìù</div>
                        <h2 style="color: #2c3e50; margin-bottom: 15px;">ƒêang ch·∫•m b√†i...</h2>
                        <p style="color: #7f8c8d; font-size: 16px;">Vui l√≤ng ch·ªù trong gi√¢y l√°t (c√≥ th·ªÉ m·∫•t 5-10 gi√¢y)</p>
                        <div style="margin-top: 20px;">
                            <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        </div>
                    </div>
                `;

                // Calculate score (with AI)
                console.log('üî¢ Calculating score...');
                const scoreData = await calculateScore();
                console.log('‚úÖ Score calculated:', scoreData);
                
                // Save to Supabase
                const userId = localStorage.getItem('userRowId') || Date.now();
                const resultData = {
                    userId: userId,
                    answers: hsk1UserAnswers,
                    score: scoreData.score,
                    writingAIScore: scoreData.writingAIScore,
                    writingAIComment: scoreData.writingAIComment,
                    selectedHSK: '1'
                };
                
                console.log('üíæ Saving to Supabase...');
                const saveResult = await saveTestResults(resultData);
                if (saveResult.success) {
                    console.log('‚úÖ Results saved to Supabase');
                } else {
                    console.warn('‚ö†Ô∏è Failed to save to Supabase:', saveResult.error);
                }
                
                // Show result
                document.getElementById('testPage').classList.remove('show');
                document.getElementById('resultPage').classList.add('show');
                
                // Display result
                displayResult(scoreData);
                
            } catch (error) {
                console.error('Error submitting test:', error);
                alert('L·ªói khi n·ªôp b√†i: ' + error.message);
            }
        }

        // ===== CALCULATE SCORE =====
        async function calculateScore() {
            let score = 0;
            const pointsPerQuestion = 2; // HSK1: 2 ƒëi·ªÉm/c√¢u
            let writingAIScore = 0;
            let writingAIComment = '';
            let listeningCorrect = 0;
            let readingCorrect = 0;
            
            const { listeningQuestions, readingQuestions, writingQuestions } = getSectionQuestions();
            
            // Score listening questions (0-4) - Multiple choice
            listeningQuestions.forEach((q, i) => {
                if (hsk1UserAnswers[i] === q.correct_answer) {
                    score += pointsPerQuestion;
                    listeningCorrect++;
                }
            });
            
            // Score reading questions (5-9) - Text input
            const readingStartIdx = listeningQuestions.length;
            readingQuestions.forEach((q, i) => {
                const globalIdx = readingStartIdx + i;
                const userAnswer = hsk1UserAnswers[globalIdx];
                const correctAnswer = q.correct_answer;
                
                if (userAnswer && correctAnswer) {
                    if (userAnswer.trim().toLowerCase() === correctAnswer.trim().toLowerCase()) {
                        score += pointsPerQuestion;
                        readingCorrect++;
                    }
                }
            });
            
            console.log('Listening correct:', listeningCorrect, '/', listeningQuestions.length);
            console.log('Reading correct:', readingCorrect, '/', readingQuestions.length);
            console.log('Score before writing:', score, '/ 20');
            
            // AI score for writing (0-10)
            try {
                const writingIndex = listeningQuestions.length + readingQuestions.length;
                const writingAnswer = hsk1UserAnswers[writingIndex];
                
                if (writingAnswer && writingAnswer.trim().length > 0) {
                    console.log('Getting AI score for writing...');
                    const aiScoreResult = await getAIWritingScore(writingAnswer, '1');
                    
                    if (aiScoreResult && typeof aiScoreResult.total !== 'undefined') {
                        writingAIScore = Math.floor(Math.max(0, Math.min(10, Number(aiScoreResult.total))));
                        score += writingAIScore;
                        console.log('AI writing score:', writingAIScore, '/ 10');
                    }
                    
                    // Get AI comment
                    writingAIComment = await getAIWritingComment(writingAnswer, '1');
                    console.log('AI comment received:', writingAIComment ? 'Yes' : 'No');
                }
            } catch (e) {
                console.warn('AI writing score failed:', e.message);
            }
            
            // Max score for HSK1 is 30 (10 questions x 2 points + 10 writing points)
            const maxScore = 30;
            if (score > maxScore) score = maxScore;
            
            console.log('Final score:', score, '/ 30');
            
            return {
                score,
                writingAIScore,
                writingAIComment,
                listeningCorrect,
                readingCorrect,
                totalQuestions: listeningQuestions.length + readingQuestions.length,
                maxScore
            };
        }

        // ===== DISPLAY RESULT =====
        async function displayResult(scoreData) {
            const fullname = localStorage.getItem('fullname') || 'Th√≠ sinh';
            const percentage = (scoreData.score / scoreData.maxScore) * 100;
            
            let levelBadge = '';
            let message = '';
            if (percentage >= 90) {
                levelBadge = 'Xu·∫•t s·∫Øc';
                message = 'Xu·∫•t s·∫Øc! B·∫°n c√≥ tr√¨nh ƒë·ªô ti·∫øng Trung r·∫•t cao, ph√≠a trung t√¢m s·∫Ω li√™n h·ªá v·ªõi b·∫°n trong th·ªùi gian ng·∫Øn nh·∫•t!';
            } else if (percentage >= 75) {
                levelBadge = 'R·∫•t t·ªët';
                message = 'R·∫•t t·ªët! B·∫°n c√≥ n·ªÅn t·∫£ng ti·∫øng Trung v·ªØng ch·∫Øc, ph√≠a trung t√¢m s·∫Ω li√™n h·ªá v·ªõi b·∫°n trong th·ªùi gian ng·∫Øn nh·∫•t!';
            } else if (percentage >= 60) {
                levelBadge = 'Kh√°';
                message = 'Kh√° t·ªët! B·∫°n ƒëang tr√™n ƒë√† ph√°t tri·ªÉn, ph√≠a trung t√¢m s·∫Ω li√™n h·ªá v·ªõi b·∫°n trong th·ªùi gian ng·∫Øn nh·∫•t!';
            } else if (percentage >= 40) {
                levelBadge = 'Trung b√¨nh';
                message = 'T·ªët! B·∫°n ƒë√£ c√≥ ki·∫øn th·ª©c c∆° b·∫£n, ph√≠a trung t√¢m s·∫Ω li√™n h·ªá v·ªõi b·∫°n trong th·ªùi gian ng·∫Øn nh·∫•t!';
            } else {
                levelBadge = 'C·∫ßn c·∫£i thi·ªán';
                message = 'B·∫°n ƒëang b·∫Øt ƒë·∫ßu h√†nh tr√¨nh h·ªçc ti·∫øng Trung, ph√≠a trung t√¢m s·∫Ω li√™n h·ªá v·ªõi b·∫°n trong th·ªùi gian ng·∫Øn nh·∫•t!';
            }
            
            document.getElementById('resultName').textContent = fullname;
            document.getElementById('resultLevel').textContent = 'HSK1';
            document.getElementById('completionTime').textContent = '60 ph√∫t';
            document.getElementById('levelBadge').textContent = levelBadge;
            document.getElementById('resultMessage').textContent = 
                `T·ªïng ƒëi·ªÉm: ${scoreData.score}/${scoreData.maxScore} ƒëi·ªÉm\n` +
                `- Nghe: ${scoreData.listeningCorrect}/5 c√¢u ƒë√∫ng (${scoreData.listeningCorrect * 2} ƒëi·ªÉm)\n` +
                `- ƒê·ªçc: ${scoreData.readingCorrect}/5 c√¢u ƒë√∫ng (${scoreData.readingCorrect * 2} ƒëi·ªÉm)\n` +
                `- Vi·∫øt: ${scoreData.writingAIScore}/10 ƒëi·ªÉm (AI ch·∫•m)\n` +
                `\n${message}`;
            
            // Get AI feedback for writing
            const writingIndex = getSectionQuestions().listeningQuestions.length + getSectionQuestions().readingQuestions.length;
            const writingAnswer = hsk1UserAnswers[writingIndex];
            
            if (writingAnswer && writingAnswer.trim().length > 0) {
                await getAIFeedbackDisplay(writingAnswer);
            }
        }
        
        // ===== GET AI FEEDBACK DISPLAY =====
        async function getAIFeedbackDisplay(essay) {
            const feedbackSection = document.querySelector('.ai-feedback-section');
            if (!feedbackSection) return;
            
            feedbackSection.style.display = 'block';
            feedbackSection.innerHTML = `
                <div class="ai-feedback-header">
                    <h3>ü§ñ Nh·∫≠n x√©t AI cho ph·∫ßn vi·∫øt</h3>
                </div>
                <div class="ai-feedback-content">
                    <div style="text-align: center; padding: 20px;">
                        <div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <div style="margin-top: 10px;">Ê≠£Âú®ÂàÜÊûêÊÇ®ÁöÑ‰ΩúÊñá... ƒêang ph√¢n t√≠ch b√†i vi·∫øt...</div>
                    </div>
                </div>
            `;
            
            try {
                const GEMINI_API_KEY = 'AIzaSyA0KtdYeuXgVA33SgZHpfYZLrsJN1uouSQ';
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `B·∫°n l√† gi√°o vi√™n ti·∫øng Trung chuy√™n nghi·ªáp. Vui l√≤ng ƒë√°nh gi√° b√†i lu·∫≠n c·ªßa h·ªçc sinh.

ch·ªß ƒë·ªÅ: Vi·∫øt ƒëo·∫°n vƒÉn 20‚Äì30 t·ª´ theo ch·ªß ƒë·ªÅ "Ng∆∞·ªùi b·∫°n c·ªßa t√¥i ‚Äì ÊàëÁöÑÊúãÂèã"

B√†i lu·∫≠n c·ªßa sinh vi√™n:
${essay}

C·∫ßn c√≥ c√°c th√¥ng tin c∆° b·∫£n:
T√™n
Tu·ªïi
Ngh·ªÅ nghi·ªáp / H·ªçc v·∫•n
S·ªü th√≠ch
Nh·∫≠n x√©t, ƒë√°nh gi√° ng·∫Øn

Xin h√£y tr·∫£ l·ªùi b·∫±ng gi·ªçng ƒëi·ªáu th√¢n thi·ªán v√† kh√≠ch l·ªá„ÄÇ`
                            }]
                        }]
                    })
                });
                
                if (!response.ok) throw new Error('AI API error');
                
                const data = await response.json();
                const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ AI.';
                
                const paragraphs = aiText.split('\n\n').filter(p => p.trim());
                let formattedHTML = '';
                paragraphs.forEach(para => {
                    formattedHTML += `<p>${para.trim().replace(/\n/g, '<br>')}</p>`;
                });
                
                feedbackSection.innerHTML = `
                    <div class="ai-feedback-header">
                        <h3>ü§ñ Nh·∫≠n x√©t AI cho ph·∫ßn vi·∫øt</h3>
                    </div>
                    <div class="ai-feedback-content">
                        ${formattedHTML || `<p>${aiText.replace(/\n/g, '<br>')}</p>`}
                    </div>
                `;
            } catch (error) {
                feedbackSection.innerHTML = `
                    <div class="ai-feedback-header">
                        <h3>ü§ñ Nh·∫≠n x√©t AI cho ph·∫ßn vi·∫øt</h3>
                    </div>
                    <div class="ai-feedback-content">
                        <p style="color: #f56565;">
                            <strong>‚ö†Ô∏è Kh√¥ng th·ªÉ l·∫•y nh·∫≠n x√©t AI</strong><br><br>
                            Vui l√≤ng li√™n h·ªá gi√°o vi√™n ƒë·ªÉ ƒë∆∞·ª£c ƒë√°nh gi√° chi ti·∫øt.
                        </p>
                    </div>
                `;
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üéâ HSK1 Test Page Loaded');
            
            try {
                // Load Supabase
                await loadSupabase();
                console.log('‚úÖ Supabase loaded');
                
                // Load questions
                await loadHSK1Questions();
                console.log('‚úÖ HSK1 test ready');
                
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                alert('L·ªói kh·ªüi t·∫°o: ' + error.message);
            }
        });

        // ===== EVENT LISTENERS =====
        document.getElementById('btnNextSection').addEventListener('click', function() {
            if (hsk1CurrentSection < 3) {
                const nextSection = hsk1CurrentSection + 1;
                displaySection(nextSection);
            }
        });

        document.getElementById('btnSubmit').addEventListener('click', submitTest);

        document.getElementById('btnFinish').addEventListener('click', function() {
            window.location.href = '../index.html';
        });
    </script>
</body>
</html>